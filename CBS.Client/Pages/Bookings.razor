@page "/bookings"
@using CBS.Client.Pages.Components
@using CBS.Model.Dto
@using CBS.Client.Services
@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject IClientService<AppointmentDto> AppointmentService
@inject IClientService<StaffDto>       StaffService
@inject IClientService<ClinicDto>      ClinicService
@inject IClientService<TimeSlotDto>    TimeSlotService
@inject IToastService ToastService

<FluentLabel Typo="Typography.H3">Bookings</FluentLabel>
<FluentLabel Typo="Typography.Body">Pending booking requests awaiting acceptance by staff or practitioners.</FluentLabel>

@* ── Toolbar ─────────────────────────────────────────────────────────── *@
<div style="margin:12px 0; display:flex; gap:1rem; align-items:center;">
    <FluentSearch Placeholder="Search patient or practitioner..."
                  @bind-Value="searchFilter"
                  @oninput="HandleSearchInput"
                  @bind-Value:after="HandleClear"
                  Style="width:320px;" />
    @if (isLoading)
    {
        <FluentProgressRing Style="width:20px; height:20px;" />
    }
    else
    {
        <FluentBadge Appearance="Appearance.Neutral">
            @FilteredItems?.Count() pending
        </FluentBadge>
    }

    <AuthorizeView Roles="User,Admin">
    <FluentButton Appearance="Appearance.Accent" OnClick="OpenBookingDialog">
        <FluentIcon Value="@(new Icons.Regular.Size16.Add())" />
        Add Booking
    </FluentButton>
    </AuthorizeView>
</div>


@* ── Grid ─────────────────────────────────────────────────────────────── *@
<div style="height:520px; overflow-x:auto; display:flex;">
    <FluentDataGrid @ref="grid"
                    Items="@FilteredItems"
                    ResizableColumns="true"
                    GridTemplateColumns="0.6fr 1.2fr 1.3fr 1.1fr 0.9fr 0.7fr 0.7fr 1fr"
                    Pagination="@pagination"
                    TGridItem="AppointmentDto">

        <PropertyColumn Property="@(b => b.Id)"
                        Title="Ref #"
                        Sortable="true"
                        Align="Align.Center" />

        <TemplateColumn Title="Patient" Sortable="false"
                        Filtered="!string.IsNullOrWhiteSpace(searchFilter)">
            <ColumnOptions>
                <div class="search-box">
                    <FluentSearch Autofocus="true"
                                  @bind-Value="searchFilter"
                                  @oninput="HandleSearchInput"
                                  @onkeydown="HandleCloseFilterAsync"
                                  @bind-Value:after="HandleClear"
                                  Placeholder="Patient ID..."
                                  Style="width:100%;"
                                  Label="Filter" />
                </div>
            </ColumnOptions>
          
        </TemplateColumn>

        <TemplateColumn Title="Practitioner" Sortable="false">
            @GetPractitionerName(context.StaffId)
        </TemplateColumn>

        <TemplateColumn Title="Clinic" Sortable="false">
            @GetClinicName(context.ClinicId)
        </TemplateColumn>

        <TemplateColumn Title="Date" Sortable="false">
            @GetSlotDate(context.TimeSlotId)
        </TemplateColumn>

        <TemplateColumn Title="Time" Sortable="false">
            @GetSlotTime(context.TimeSlotId)
        </TemplateColumn>

        <TemplateColumn Title="Status" Align="Align.Center">
            <FluentBadge Appearance="Appearance.Neutral" Color="Color.Warning">Pending</FluentBadge>
        </TemplateColumn>

        <TemplateColumn Title="Actions" Align="Align.Center">
            <FluentButton Appearance="Appearance.Accent"
                          Title="Accept — promotes this booking to a confirmed appointment"
                          Disabled="@isBusy"
                          IconStart="@(new Icons.Regular.Size16.CheckmarkCircle())"
                          OnClick="@(() => ConfirmAccept(context))"
                          style="margin-right:.4rem">
                Accept
            </FluentButton>
            <FluentButton Appearance="Appearance.Outline"
                          Title="Reject — deletes this booking request"
                          Disabled="@isBusy"
                          IconStart="@(new Icons.Regular.Size16.DismissCircle())"
                          OnClick="@(() => ConfirmReject(context))">
                Reject
            </FluentButton>
        </TemplateColumn>

    </FluentDataGrid>
</div>

<FluentPaginator State="@pagination" />

@* ── Accept Confirmation Dialog ───────────────────────────────────────── *@
<FluentDialog @ref="acceptDialog"
              Modal="true"
              TrapFocus="true"
              style="--dialog-width:420px">
    <FluentDialogHeader>Accept Booking</FluentDialogHeader>
    <FluentDialogBody>
        <FluentLabel>
            Accept the booking request <strong>#@pendingItem?.Id</strong> for
            Patient <strong>#@pendingItem?.PatientId</strong> with
            <strong>@GetPractitionerName(pendingItem?.StaffId ?? 0)</strong>?
        </FluentLabel>
        <FluentLabel style="margin-top:.5rem; display:block; color:var(--neutral-foreground-hint)">
            This will confirm the appointment and move it out of the pending queue.
        </FluentLabel>
        @if (!string.IsNullOrWhiteSpace(actionError))
        {
            <FluentMessageBar Intent="MessageIntent.Error" style="margin-top:.75rem">
                @actionError
            </FluentMessageBar>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent"
                      Disabled="@isBusy"
                      OnClick="ExecuteAccept">
            @(isBusy ? "Accepting…" : "Yes, Accept")
        </FluentButton>
        <FluentButton Appearance="Appearance.Outline"
                      OnClick="@(() => acceptDialog!.Hide())">
            Cancel
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@* ── Reject Confirmation Dialog ───────────────────────────────────────── *@
<FluentDialog @ref="rejectDialog"
              Modal="true"
              TrapFocus="true"
              style="--dialog-width:420px">
    <FluentDialogHeader>Reject Booking</FluentDialogHeader>
    <FluentDialogBody>
        <FluentLabel>
            Are you sure you want to reject booking <strong>#@pendingItem?.Id</strong> for
            Patient <strong>#@pendingItem?.PatientId</strong>?
        </FluentLabel>
        <FluentLabel style="margin-top:.5rem; display:block; color:var(--neutral-foreground-hint)">
            The booking request will be permanently deleted and the timeslot will be released.
        </FluentLabel>
        @if (!string.IsNullOrWhiteSpace(actionError))
        {
            <FluentMessageBar Intent="MessageIntent.Error" style="margin-top:.75rem">
                @actionError
            </FluentMessageBar>
        }
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent"
                      Disabled="@isBusy"
                      OnClick="ExecuteReject">
            @(isBusy ? "Rejecting…" : "Yes, Reject")
        </FluentButton>
        <FluentButton Appearance="Appearance.Outline"
                      OnClick="@(() => rejectDialog!.Hide())">
            Cancel
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<FluentDialog @ref="BookingDialog" @bind-Hidden="@BookingHidden" aria-label="Register a new account..." Modal=true>
    <BookingWizard  />
    <Register   />
</FluentDialog>
@code {

    // ── State ────────────────────────────────────────────────────────────
    FluentDataGrid<AppointmentDto>? grid;
    PaginationState pagination = new PaginationState { ItemsPerPage = 12 };

    private List<AppointmentDto> allItems      = new();
    private List<StaffDto>       allStaff      = new();
    private List<ClinicDto>      allClinics    = new();
    private List<TimeSlotDto>    allTimeslots  = new();

    private AppointmentDto? pendingItem;   // item awaiting Accept or Reject confirmation
    private FluentDialog?   acceptDialog;
    private FluentDialog?   rejectDialog;

    private string searchFilter = string.Empty;
    private string actionError  = string.Empty;
    private bool   isLoading    = true;
    private bool   isBusy       = false;
    private FluentDialog? BookingDialog;
    private bool BookingHidden = true;
    // ── Filtered view: only records where IsActive == false (pending bookings) ──
    private IQueryable<AppointmentDto>? FilteredItems
    {
        get
        {
            // Base: only pending (not yet accepted)
            var pending = allItems.Where(b => !b.IsActive);

            if (!string.IsNullOrWhiteSpace(searchFilter))
            {
                pending = pending.Where(b =>
                    b.PatientId.ToString().Contains(searchFilter)                                             ||
                    GetPractitionerName(b.StaffId).Contains(searchFilter, StringComparison.CurrentCultureIgnoreCase) ||
                    GetClinicName(b.ClinicId).Contains(searchFilter, StringComparison.CurrentCultureIgnoreCase));
            }

            return pending.AsQueryable();
        }
    }

    // ── Lifecycle ─────────────────────────────────────────────────────────
    protected override async Task OnInitializedAsync()
    {
        AppointmentService.EndPoint = "api/appointment";
        StaffService.EndPoint       = "api/staff";
        ClinicService.EndPoint      = "api/clinic";
        TimeSlotService.EndPoint    = "api/timeslot";
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var apptTask   = AppointmentService.List();
            var staffTask  = StaffService.List();
            var clinicTask = ClinicService.List();
            var slotTask   = TimeSlotService.List();
            await Task.WhenAll(apptTask, staffTask, clinicTask, slotTask);

            allItems     = (await apptTask).ToList();
            allStaff     = (await staffTask).ToList();
            allClinics   = (await clinicTask).ToList();
            allTimeslots = (await slotTask).ToList();
        }
        catch (HttpRequestException)
        {
            ToastService.ShowError("Could not reach the server. Please check your connection.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"An unexpected error occurred: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    // ── Lookup helpers ────────────────────────────────────────────────────
    private string GetPractitionerName(long staffId)
        => allStaff.FirstOrDefault(s => s.Id == staffId)?.FullNames ?? $"Staff #{staffId}";

    private string GetClinicName(long clinicId)
        => allClinics.FirstOrDefault(c => c.Id == clinicId)?.ClinicName ?? $"Clinic #{clinicId}";

    private string GetSlotDate(long slotId)
    {
        var slot = allTimeslots.FirstOrDefault(t => t.Id == slotId);
        return slot is null ? "—" : slot.FromDateTime.ToString("dd MMM yyyy");
    }

    private string GetSlotTime(long slotId)
    {
        var slot = allTimeslots.FirstOrDefault(t => t.Id == slotId);
        return slot is null ? "—" : $"{slot.FromDateTime:HH:mm} – {slot.ToDateTime:HH:mm}";
    }

    // ── Search ────────────────────────────────────────────────────────────
    private void HandleSearchInput(ChangeEventArgs args)
    {
        if (args.Value is string value)
            searchFilter = value;
    }
    private void OpenBookingDialog(){
        BookingHidden = false;
    }
    private void HandleClear()
    {
        if (string.IsNullOrWhiteSpace(searchFilter))
            searchFilter = string.Empty;
    }

    private async Task HandleCloseFilterAsync(KeyboardEventArgs args)
    {
        if (args.Key == "Escape")
            searchFilter = string.Empty;

        if (args.Key == "Enter" && grid is not null)
            await grid.CloseColumnOptionsAsync();
    }

    // ── Accept flow ───────────────────────────────────────────────────────
    // Accepting = set IsActive = true on the existing record via Edit().
    // No new DTO, no new service method — same pattern as everywhere else.
    private void ConfirmAccept(AppointmentDto item)
    {
        pendingItem = item;
        actionError = string.Empty;
        acceptDialog!.Show();
    }

    private async Task ExecuteAccept()
    {
        if (pendingItem is null || isBusy) return;
        isBusy      = true;
        actionError = string.Empty;

        try
        {
            // Clone and flip the flag — IsActive true = confirmed appointment
            var accepted = new AppointmentDto
            {
                Id         = pendingItem.Id,
                PatientId  = pendingItem.PatientId,
                StaffId    = pendingItem.StaffId,
                ClinicId   = pendingItem.ClinicId,
                TimeSlotId = pendingItem.TimeSlotId,
                IsActive   = true   // <-- promotion from Booking → Appointment
            };

            var result = await AppointmentService.Edit(accepted.Id, accepted);

            if (result.Key)
            {
                ToastService.ShowSuccess($"Booking #{pendingItem.Id} accepted — now a confirmed appointment.");
                acceptDialog!.Hide();
                await LoadData();
            }
            else
            {
                actionError = result.Value;
            }
        }
        catch (HttpRequestException)
        {
            actionError = "Could not reach the server. Please check your connection and try again.";
        }
        catch (Exception ex)
        {
            actionError = $"An unexpected error occurred: {ex.Message}";
        }
        finally
        {
            isBusy      = false;
            pendingItem = null;
        }
    }

    // ── Reject flow ───────────────────────────────────────────────────────
    // Rejecting = hard delete via Delete(). The timeslot becomes available again.
    private void ConfirmReject(AppointmentDto item)
    {
        pendingItem = item;
        actionError = string.Empty;
        rejectDialog!.Show();
    }

    private async Task ExecuteReject()
    {
        if (pendingItem is null || isBusy) return;
        isBusy      = true;
        actionError = string.Empty;

        try
        {
            var result = await AppointmentService.Delete(pendingItem.Id);

            if (result.Key)
            {
                ToastService.ShowSuccess($"Booking #{pendingItem.Id} rejected and removed.");
                rejectDialog!.Hide();
                await LoadData();
            }
            else
            {
                actionError = result.Value;
            }
        }
        catch (HttpRequestException)
        {
            actionError = "Could not reach the server. Please check your connection and try again.";
        }
        catch (Exception ex)
        {
            actionError = $"An unexpected error occurred: {ex.Message}";
        }
        finally
        {
            isBusy      = false;
            pendingItem = null;
        }
    }
}
