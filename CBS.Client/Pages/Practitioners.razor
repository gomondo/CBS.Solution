@page "/practitioners"
@using Microsoft.FluentUI.AspNetCore.Components
@using CBS.Client.Services
@using CBS.Model.Dto
@using System.ComponentModel.DataAnnotations
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject IClientService<StaffDto> ClinicService;
<FluentLabel Typo="Typography.H3">Practitioners</FluentLabel>

<h3>Health Practitioners</h3>

<FluentLabel Typo="Typography.H3">Clinics</FluentLabel>

<div style="margin: 12px 0;">
    <FluentSearch Placeholder="Search clinics..."
                  @bind-Value="searchFilter"
                  @oninput="HandleSearchInput"
                  @bind-Value:after="HandleClear"
                  Style="width: 320px;" />
</div>


<div style="height: 520px; overflow-x: auto; display: flex;">
    <FluentDataGrid @ref="grid"
                    Items="@FilteredItems"
                    ResizableColumns="true"
                    GridTemplateColumns="0.6fr 1.2fr 1fr 1fr 0.8fr 0.6fr"
                    Pagination="@pagination"
                    TGridItem="StaffDto">
        <PropertyColumn Property="@(c => c.Id)" Title="ID" Sortable="true" Align="Align.Center" />
        <PropertyColumn Property="@(c => c.ClinicName)" Title="Clinic Name" Sortable="true" Filtered="!string.IsNullOrWhiteSpace(searchFilter)">
            <ColumnOptions>
                <div class="search-box">
                    <FluentSearch Autofocus="true"
                                  @bind-Value="searchFilter"
                                  @oninput="HandleSearchInput"
                                  @onkeydown="HandleCloseFilterAsync"
                                  @bind-Value:after="HandleClear"
                                  Placeholder="Clinic name..."
                                  Style="width: 100%;"
                                  Label="Filter" />
                </div>
            </ColumnOptions>
        </PropertyColumn>
        <PropertyColumn Property="@(c => c.Email)" Title="Email" Sortable="true" />
        <PropertyColumn Property="@(c => c.FullNames)" Title="Address" Sortable="true" />
        <PropertyColumn Property="@(c => c.Specility)" Title="Specility" />
        <TemplateColumn Title="Active" Align="Align.Center">
            @if (context.IsActive)
            {
                <FluentIcon Value="@(new Icons.Regular.Size16.CheckmarkCircle())" />
            }
            else
            {
                <FluentIcon Value="@(new Icons.Regular.Size16.DismissCircle())" />
            }
        </TemplateColumn>
    </FluentDataGrid>
</div>

<FluentPaginator State="@pagination" />

@code {
    FluentDataGrid<StaffDto>? grid;
    IQueryable<StaffDto>? items;
    PaginationState pagination = new PaginationState { ItemsPerPage = 12 };
    string searchFilter = string.Empty;

    IQueryable<StaffDto>? FilteredItems
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchFilter))
                return items;

            return items?.Where(c =>
                c.ClinicName.Contains(searchFilter, StringComparison.CurrentCultureIgnoreCase) ||
                c.FullNames.Contains(searchFilter, StringComparison.CurrentCultureIgnoreCase));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // var data = await ClinicService.GetClinicsAsync();
        // items = data.AsQueryable();
    }

    private void HandleSearchInput(ChangeEventArgs args)
    {
        if (args.Value is string value)
            searchFilter = value;
    }

    private void HandleClear()
    {
        if (string.IsNullOrWhiteSpace(searchFilter))
            searchFilter = string.Empty;
    }

    private async Task HandleCloseFilterAsync(KeyboardEventArgs args)
    {
        if (args.Key == "Escape")
            searchFilter = string.Empty;

        if (args.Key == "Enter" && grid is not null)
            await grid.CloseColumnOptionsAsync();
    }
}
